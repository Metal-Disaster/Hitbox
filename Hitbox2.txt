local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Variables de control
local originalSizes = {}
local active = false
local heartbeatConnection = nil
local lastTeamState = false

-- Función de validación mejorada para team Survivor
local function ValidateTeam()
    local charFolder = workspace:FindFirstChild("LocalPlayer")
    if not charFolder then return false end
    
    local characterFolder = charFolder:FindFirstChild("CharacterFolder")
    if not characterFolder then return false end
    
    local characterTeam = characterFolder:FindFirstChild("CharacterTeam")
    if not characterTeam then return false end
    
    -- Verificar si está en team Survivor
    return characterTeam:FindFirstChild("survivor") ~= nil
end

-- Función principal de modificación
local function ModifyHitboxes(enable)
    local teamValid = ValidateTeam()
    
    -- Obtener el módulo de hitboxes
    local hitboxModule = workspace:FindFirstChild("gameInstance")
    if hitboxModule then
        hitboxModule = hitboxModule:FindFirstChild("hitBoxModule")
        if hitboxModule then
            local playersFolder = hitboxModule:FindFirstChild("Players")
            if playersFolder then
                -- Procesar cada jugador
                for _, playerInFolder in ipairs(playersFolder:GetChildren()) do
                    local hitFolder = playerInFolder:FindFirstChild("HitFolder")
                    if hitFolder then
                        local collision = hitFolder:FindFirstChild("collision")
                        if collision then
                            if enable and teamValid then
                                -- Guardar tama09o original si no existe
                                if not originalSizes[playerInFolder.Name] then
                                    originalSizes[playerInFolder.Name] = collision.Size
                                end
                                -- Aplicar nuevo tama09o (30, 10, 30)
                                collision.Size = Vector3.new(30, 10, 30)
                            elseif originalSizes[playerInFolder.Name] then
                                -- Restaurar tama09o original si existe
                                collision.Size = originalSizes[playerInFolder.Name]
                            end
                        end
                    end
                end
            end
        end
    end
end

-- Loop de actualización con detección de cambios de team
local function MainLoop()
    local currentTeamState = ValidateTeam()
    
    -- Detectar cambios en el estado del team
    if lastTeamState ~= currentTeamState then
        if currentTeamState then
            -- Acabamos de entrar al team survivor
            if active then
                ModifyHitboxes(true)
            end
        else
            -- Acabamos de salir del team survivor
            ModifyHitboxes(false)
        end
        lastTeamState = currentTeamState
    end
    
    -- Solo modificar si está activo y en team válido
    if active and currentTeamState then
        ModifyHitboxes(true)
    end
end

-- Función de control principal
local function SetActive(state)
    active = state
    
    if active then
        -- Iniciar el sistema
        heartbeatConnection = RunService.Heartbeat:Connect(MainLoop)
        lastTeamState = ValidateTeam()
        ModifyHitboxes(true)
    else
        -- Detener el sistema
        if heartbeatConnection then
            heartbeatConnection:Disconnect()
            heartbeatConnection = nil
        end
        ModifyHitboxes(false)
    end
end

return SetActive